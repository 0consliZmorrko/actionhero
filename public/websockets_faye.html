<script src="/faye/client.js"></script>

<script>

var actionHeroWebSocket = function(options, callback){
  var self = this;
  if(callback == null && typeof options == "function"){
    callback = options; options = null;
  }

  self.messageCount = 0;
  self.callbacks = {};
  self.id = null;
  self.events = {};

  self.options = self.defaults();
  for(var i in options){
    self.options[i] = options[i];
  }
}

actionHeroWebSocket.prototype.defaults = function(){
  return {
    host: window.location.origin,
    path: "/faye",
    setupChannel: "/_welcome",
    channelPrefix: "/client/websocket/connection/"
  }
}

actionHeroWebSocket.prototype.log = function(message){
  if(console && console.log){
    if(typeof message != "string"){ message = JSON.stringify(message); }
    var date = new Date();
    var times = [date.getHours().toString(), date.getMinutes().toString(), date.getSeconds().toString()];
    for(var i in times){
      if(times[i].length < 2){ times[i] = "0" + times[i]; }
    }
    console.log("[AH::client @ " + times.join(":") + "] " + message);
  }
}

actionHeroWebSocket.prototype.connect = function(callback){
  var self = this;

  self.client = new Faye.Client(self.options.host + self.options.path);
  
  var initialMessage = self.client.publish(self.options.setupChannel, 'hello');
  
  initialMessage.callback(function() {
    self.id = self.client.getClientId()
    self.channel = self.options.channelPrefix + self.id;
    self.subscription = self.client.subscribe(self.channel, function(message) {
      self.handleMessage(message);
    });
    callback(null, self);
  });

  initialMessage.errback(function(error) {
    callback(error, null);
  })
}

actionHeroWebSocket.prototype.send = function(args, callback){
  var self = this;
  self.messageCount++;
  self.callbacks[self.messageCount] = callback;
  self.client.publish(self.channel, args).errback(function(err){
    self.log(err);
  });
};

actionHeroWebSocket.prototype.handleMessage = function(message){
  var self = this;

  if(message.context == "response"){
    if(typeof self.callbacks[self.messageCount] === 'function'){
      self.callbacks[self.messageCount](message);
    }
    delete self.callbacks[self.messageCount];
  }

  else if(message.context == "user"){
    if(typeof self.events.say == 'function'){
      self.events.say(message);
    }
  }

  else{
    if(typeof self.events.alert == 'function'){
      self.events.alert(message);
    }
  }
};

actionHeroWebSocket.prototype.say = function(message, callback){
  this.send({
    event: 'say', 
    message: message,
  }, callback);
}

</script>


<script>

  var A = new actionHeroWebSocket
  A.events.say = function(message){
    A.log("SAY:");
    A.log(message)
  }
  A.events.alert = function(message){
    A.log("ALERT:");
    A.log(message)
  }
  A.connect(function(err){
    if(err != null){
      A.log(err);
    }else{
      A.log("CONNECTED");
    }
  });

</script>